#!/bin/bash
#
# clad - Claude with Automatic credential Detection
#
# Selects the best available Claude credential based on rate limit usage,
# then launches Claude Code in dangerous mode.
#
# Credential priority:
#   1. Project-level .claude-credentials.json symlink (if present in cwd)
#   2. Default ~/.claude/.credentials.json
#   3. All other ~/.claude/.credentials-*.json files
#
# Selection algorithm:
#   - Check preferred key first. If <99% used, keep it.
#   - If >=99%, cycle through remaining keys.
#   - First key found with <90% usage wins.
#   - If all >=90%, use the key with lowest usage.

set -euo pipefail

CLAUDE_DIR="$HOME/.claude"
DEFAULT_CREDS="$CLAUDE_DIR/.credentials.json"

# ── Colors ──────────────────────────────────────────────────────────────────

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

log()         { echo -e "  ${BLUE}▸${NC} $1"; }
log_success() { echo -e "  ${GREEN}✓${NC} $1"; }
log_warn()    { echo -e "  ${YELLOW}⚠${NC} $1"; }
log_error()   { echo -e "  ${RED}✗${NC} $1"; }
log_header()  { echo -e "\n${CYAN}${BOLD}── $1 ──${NC}"; }

# ── Dependency check ────────────────────────────────────────────────────────

for cmd in jq curl claude; do
    if ! command -v "$cmd" &>/dev/null; then
        log_error "Required command '${BOLD}$cmd${NC}' not found"
        exit 1
    fi
done

# ── Step 1: Discover credential files ───────────────────────────────────────

log_header "Discovering credentials"

CRED_FILES=()
for f in "$CLAUDE_DIR"/.credentials-*.json; do
    [ -f "$f" ] && CRED_FILES+=("$f")
done

if [ ${#CRED_FILES[@]} -eq 0 ]; then
    log_warn "No alternate credential files found"
    log "Launching with default credentials..."
    exec claude --dangerously-skip-permissions "$@"
fi

for f in "${CRED_FILES[@]}"; do
    tier=$(jq -r '.claudeAiOauth.rateLimitTier // "unknown"' "$f" 2>/dev/null)
    log "Found $(basename "$f") ${DIM}($tier)${NC}"
done

# ── Step 2: Determine preferred credential ──────────────────────────────────

log_header "Determining priority"

PREFERRED_CRED=""

# Check for project-level symlink/file in current directory
if [ -e ".claude-credentials.json" ]; then
    target=$(readlink -f ".claude-credentials.json" 2>/dev/null || realpath ".claude-credentials.json" 2>/dev/null)
    if [ -f "$target" ]; then
        PREFERRED_CRED="$target"
        if [ -L ".claude-credentials.json" ]; then
            log "Project symlink → $(basename "$target")"
        else
            log "Project credential: $(basename "$target")"
        fi
    fi
fi

# Fallback: match current default to a named file by refresh token
if [ -z "$PREFERRED_CRED" ] && [ -f "$DEFAULT_CREDS" ]; then
    default_refresh=$(jq -r '.claudeAiOauth.refreshToken // empty' "$DEFAULT_CREDS" 2>/dev/null)
    if [ -n "$default_refresh" ]; then
        for f in "${CRED_FILES[@]}"; do
            f_refresh=$(jq -r '.claudeAiOauth.refreshToken // empty' "$f" 2>/dev/null)
            if [ "$default_refresh" = "$f_refresh" ]; then
                PREFERRED_CRED="$f"
                log "Default matches $(basename "$f")"
                break
            fi
        done
    fi
fi

# Ultimate fallback: first named file
if [ -z "$PREFERRED_CRED" ]; then
    PREFERRED_CRED="${CRED_FILES[0]}"
    log "Default preference: $(basename "$PREFERRED_CRED")"
fi

# Build ordered list: preferred first, then others
ORDERED_CREDS=("$PREFERRED_CRED")
for f in "${CRED_FILES[@]}"; do
    [ "$f" != "$PREFERRED_CRED" ] && ORDERED_CREDS+=("$f")
done

# ── Step 3: Check rate limit usage ──────────────────────────────────────────

log_header "Checking rate limits"

# Returns usage percentage (0-100), or:
#   -1 = unknown/error
#   -2 = token expired
get_usage_pct() {
    local cred_file="$1"
    local access_token
    access_token=$(jq -r '.claudeAiOauth.accessToken // empty' "$cred_file" 2>/dev/null)

    if [ -z "$access_token" ]; then
        echo "-1"
        return
    fi

    # Check token expiry before making API call
    local expires_at now_ms
    expires_at=$(jq -r '.claudeAiOauth.expiresAt // 0' "$cred_file" 2>/dev/null)
    now_ms=$(( $(date +%s) * 1000 ))

    if [ "$expires_at" -gt 0 ] 2>/dev/null && [ "$expires_at" -lt "$now_ms" ] 2>/dev/null; then
        echo "-2"
        return
    fi

    # Minimal API call to read rate limit headers
    local tmp_headers
    tmp_headers=$(mktemp)
    local tmp_body
    tmp_body=$(mktemp)

    local http_code
    http_code=$(curl -s -o "$tmp_body" -D "$tmp_headers" -w '%{http_code}' \
        -H "Authorization: Bearer $access_token" \
        -H "anthropic-version: 2023-06-01" \
        -H "content-type: application/json" \
        -d '{"model":"claude-haiku-4-5-20251001","max_tokens":1,"messages":[{"role":"user","content":"x"}]}' \
        "https://api.anthropic.com/v1/messages" 2>/dev/null) || true

    # 429 = rate limited
    if [ "$http_code" = "429" ]; then
        rm -f "$tmp_headers" "$tmp_body"
        echo "100"
        return
    fi

    # Auth failure
    if [ "$http_code" = "401" ] || [ "$http_code" = "403" ]; then
        rm -f "$tmp_headers" "$tmp_body"
        echo "-1"
        return
    fi

    # Parse rate limit headers
    local remaining limit
    remaining=$(grep -i 'anthropic-ratelimit-tokens-remaining' "$tmp_headers" 2>/dev/null | awk '{print $2}' | tr -d '\r\n' || true)
    limit=$(grep -i 'anthropic-ratelimit-tokens-limit' "$tmp_headers" 2>/dev/null | awk '{print $2}' | tr -d '\r\n' || true)

    rm -f "$tmp_headers" "$tmp_body"

    if [ -n "$remaining" ] && [ -n "$limit" ] && [ "$limit" -gt 0 ] 2>/dev/null; then
        local used pct
        used=$((limit - remaining))
        if [ "$used" -lt 0 ]; then used=0; fi
        pct=$((used * 100 / limit))
        echo "$pct"
    elif [ "$http_code" = "200" ]; then
        # API succeeded but no rate limit headers — assume fine
        echo "0"
    else
        echo "-1"
    fi
}

BEST_CRED=""
BEST_USAGE=101

for cred in "${ORDERED_CREDS[@]}"; do
    name=$(basename "$cred")
    log "Checking ${BOLD}$name${NC}..."

    usage=$(get_usage_pct "$cred")

    case "$usage" in
        -2)
            log_warn "  Token expired — Claude will refresh on launch"
            # Can't verify usage; treat as a fallback candidate
            if [ -z "$BEST_CRED" ]; then
                BEST_CRED="$cred"
                BEST_USAGE=50  # optimistic guess
            fi
            continue
            ;;
        -1)
            log_warn "  Could not determine usage"
            continue
            ;;
        100)
            log_error "  Rate limited (100%)"
            ;;
        *)
            if [ "$usage" -lt 50 ]; then
                log_success "  ${usage}% used — plenty of capacity"
            elif [ "$usage" -lt 90 ]; then
                log_success "  ${usage}% used"
            else
                log_warn "  ${usage}% used — running low"
            fi
            ;;
    esac

    # Selection logic:
    # Preferred key with <99% usage → use immediately
    if [ "$cred" = "$PREFERRED_CRED" ] && [ "$usage" -lt 99 ]; then
        BEST_CRED="$cred"
        BEST_USAGE=$usage
        break
    fi

    # Any key with <90% usage → use immediately
    if [ "$usage" -lt 90 ]; then
        BEST_CRED="$cred"
        BEST_USAGE=$usage
        break
    fi

    # Track lowest usage as fallback
    if [ "$usage" -lt "$BEST_USAGE" ]; then
        BEST_CRED="$cred"
        BEST_USAGE=$usage
    fi
done

# ── Step 4: Select and activate ─────────────────────────────────────────────

log_header "Activating credential"

if [ -z "$BEST_CRED" ]; then
    BEST_CRED="$PREFERRED_CRED"
    log_warn "No usage data available — using preferred: $(basename "$BEST_CRED")"
elif [ "$BEST_USAGE" -ge 90 ]; then
    log_warn "All keys heavily used — best available: $(basename "$BEST_CRED") (${BEST_USAGE}%)"
else
    log_success "Selected: $(basename "$BEST_CRED") (${BEST_USAGE}% used)"
fi

# Copy selected credential to default location
cp "$BEST_CRED" "$DEFAULT_CREDS"
log_success "Credential activated"

# ── Step 5: Launch Claude ───────────────────────────────────────────────────

echo ""
log_success "${BOLD}Launching Claude Code${NC}"
echo ""

exec claude --dangerously-skip-permissions "$@"
